## âš™ï¸ **Complete `create_user` Flow in FastAPI**

### âœ… 1. `schemas.py` â€” Request & Response Models

```python
from pydantic import BaseModel, EmailStr

class UserCreate(BaseModel):
    name: str
    email: EmailStr
    password: str

class UserResponse(BaseModel):
    id: int
    name: str
    email: EmailStr

    class Config:
        orm_mode = True  # important to work with ORM objects
```

---

### âœ… 2. `models.py` â€” SQLAlchemy User Model

```python
from sqlalchemy import Column, Integer, String
from database import Base

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False)
    email = Column(String, unique=True, index=True)
    password = Column(String, nullable=False)  # store hashed password
```

---

### âœ… 3. `database.py` â€” DB Setup + Dependency

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "sqlite:///./test.db"  # or PostgreSQL, MySQL etc.

engine = create_engine(DATABASE_URL, connect_args={"check_same_thread": False})
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

# Dependency to use in routes
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

---

### âœ… 4. `crud.py` â€” Business Logic (Service Layer)

```python
from sqlalchemy.orm import Session
from models import User
from schemas import UserCreate
from utils import hash_password  # if using hashing

def create_user(db: Session, user: UserCreate):
    db_user = User(
        name=user.name,
        email=user.email,
        password=hash_password(user.password)  # optional hashing
    )
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user
```

---

### âœ… 5. `utils.py` â€” (Optional) Password Hashing

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)
```

---

### âœ… 6. `main.py` â€” FastAPI Route Using Dependency

```python
from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.orm import Session
import models, schemas, crud
from database import engine, get_db

models.Base.metadata.create_all(bind=engine)

app = FastAPI()

@app.post("/users/", response_model=schemas.UserResponse)
def create_user(user: schemas.UserCreate, db: Session = Depends(get_db)):
    db_user = crud.create_user(db, user)
    return db_user
```

---

## ğŸ” Full Requestâ€“Response Flow

1. ğŸŒ **Request:**

   ```json
   POST /users/
   {
     "name": "Darshan",
     "email": "darshan@example.com",
     "password": "secret123"
   }
   ```

2. ğŸ¯ **FastAPI Route:**

   * Validates using `UserCreate`
   * Injects `db` session via `Depends(get_db)`

3. âš™ï¸ **Business Logic (CRUD Layer):**

   * Calls `create_user(db, user)`
   * Hashes password (optional)
   * Adds user to DB

4. ğŸ§± **SQLAlchemy Model:**

   * Maps to `users` table

5. ğŸ“¤ **Response:**
   Returns `UserResponse` model (hides password!)

---

## ğŸ§  Bonus: Folder Structure

```
project/
â”‚
â”œâ”€â”€ main.py
â”œâ”€â”€ models.py
â”œâ”€â”€ schemas.py
â”œâ”€â”€ crud.py
â”œâ”€â”€ database.py
â”œâ”€â”€ utils.py
â””â”€â”€ requirements.txt
```

---

## âœ… Features Used

| Concept                 | Usage                         |
| ----------------------- | ----------------------------- |
| ğŸ§© Pydantic Models      | `UserCreate`, `UserResponse`  |
| ğŸ›¢ SQLAlchemy ORM       | `User` model in `models.py`   |
| ğŸ§¬ Dependency Injection | `Depends(get_db)` in route    |
| ğŸ”„ DB Abstraction       | `crud.create_user(db, user)`  |
| ğŸ” Optional Security    | `hash_password` via `passlib` |

--- 

# ğŸ”„ **1. FastAPI `create_user` Flow â€“ Arrow Diagram & Explanation**

```
CLIENT (e.g., Postman, React) sends JSON payload
    |
    V
POST /users/         ğŸ”¸ Request: { "name": "Darshan", "email": "...", "password": "1234" }
    |
    V
@app.post("/users/")
def create_user(user: UserCreate, db: Session = Depends(get_db)):
    |
    â”œâ”€â”€ Validates body using â†’ ğŸ§© Pydantic `UserCreate`
    â””â”€â”€ Injects DB session â†’ ğŸ§¬ Depends(get_db)
        |
        V
    Calls â crud.create_user(db, user)
               |
               â””â”€â”€ Creates new User ORM object
               â””â”€â”€ Hashes password (optional)
               â””â”€â”€ db.add(), db.commit(), db.refresh()
        |
        V
    Returns â UserResponse (without password)
    |
    V
Client receives JSON:
{
  "id": 1,
  "name": "Darshan",
  "email": "darshan@example.com"
}
```

---

## ğŸ“¦ Data Flow Breakdown:

* **Pydantic Schema**: Input validated (`UserCreate`)
* **Dependency Injection**: `get_db` provides a DB session
* **Business Logic (CRUD)**: `create_user` interacts with DB
* **ORM (SQLAlchemy)**: Handles table & row management
* **Response Model**: Returns only `id`, `name`, `email`

---

# ğŸ” **2. JWT Authentication Flow in FastAPI**

Letâ€™s now explore how **JWT Login works** using password validation, token generation, and protection of private routes.

---

## ğŸ” JWT Flow â€“ Arrow Diagram

```
CLIENT sends login credentials:
POST /login
{ "username": "darshan", "password": "1234" }
    |
    V
@app.post("/login")
    |
    â”œâ”€â”€ Verifies username in DB
    â”œâ”€â”€ Validates password using hash check
    â””â”€â”€ If valid:
          |
          V
       Generate JWT using PyJWT
       Return token â†’ { "access_token": "<JWT>", "token_type": "bearer" }

Then, on protected routes:

CLIENT calls:
GET /profile with Header: Authorization: Bearer <JWT>
    |
    V
Depends(get_current_user)
    â”œâ”€â”€ Decodes JWT
    â”œâ”€â”€ Verifies signature
    â”œâ”€â”€ Gets user_id/email from payload
    â””â”€â”€ Loads user from DB
    |
    V
Returns secure data
```

---

## âœ… Code Breakdown

### 1ï¸âƒ£ Generate Token â€“ `auth.py`

```python
from datetime import datetime, timedelta
from jose import JWTError, jwt

SECRET_KEY = "your-secret"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
```

---

### 2ï¸âƒ£ Login Route â€“ `routes.py`

```python
from fastapi import APIRouter, Depends, HTTPException
from fastapi.security import OAuth2PasswordRequestForm
from sqlalchemy.orm import Session
from auth import create_access_token
from utils import verify_password
from models import User
from database import get_db

router = APIRouter()

@router.post("/login")
def login(form_data: OAuth2PasswordRequestForm = Depends(), db: Session = Depends(get_db)):
    user = db.query(User).filter(User.email == form_data.username).first()
    if not user or not verify_password(form_data.password, user.password):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    access_token = create_access_token(data={"sub": user.email})
    return {"access_token": access_token, "token_type": "bearer"}
```

---

### 3ï¸âƒ£ Protected Route

```python
from fastapi import Depends
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt
from sqlalchemy.orm import Session

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/login")

def get_current_user(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        email: str = payload.get("sub")
        if not email:
            raise HTTPException(status_code=401)
    except JWTError:
        raise HTTPException(status_code=401)

    user = db.query(User).filter(User.email == email).first()
    return user
```

Use in route:

```python
@app.get("/me")
def read_profile(current_user: User = Depends(get_current_user)):
    return current_user
```

---

## âœ… Summary Table â€“ JWT Auth Flow

| Step        | Action                                 | Tool Used                   |
| ----------- | -------------------------------------- | --------------------------- |
| ğŸ” Login    | POST `/login` with `username/password` | `OAuth2PasswordRequestForm` |
| âœ… Validate  | Check password hash, issue token       | `passlib`, `jose`           |
| ğŸ”‘ Token    | JWT with `sub` (email) and `exp`       | `create_access_token()`     |
| ğŸ“¦ Protect  | Decode token in protected routes       | `get_current_user()`        |
| ğŸ“¤ Response | Secured user data                      | Token-based access          |

---

# âœ… **USER CREATION SYSTEM CHECKLIST**

| âœ… Step | Description                         | File          |
| ------ | ----------------------------------- | ------------- |
| âœ”ï¸ 1   | DB Engine + Session Setup           | `database.py` |
| âœ”ï¸ 2   | SQLAlchemy Model for User           | `models.py`   |
| âœ”ï¸ 3   | Pydantic Request & Response Schemas | `schemas.py`  |
| âœ”ï¸ 4   | User CRUD Logic                     | `db_user.py`  |
| âœ”ï¸ 5   | API Route for `/users/`             | `user.py`     |
| âœ”ï¸ 6   | Main App Mounting Routes            | `main.py`     |

---

# ğŸ§± **1. `database.py` â€“ Setup DB Connection & Session**

```python
# database.py
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "sqlite:///./users.db"

engine = create_engine(
    DATABASE_URL, connect_args={"check_same_thread": False}  # SQLite specific
)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()

# Dependency
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

---

# ğŸ“¦ **2. `models.py` â€“ User Table Definition**

```python
# models.py
from sqlalchemy import Column, Integer, String
from database import Base

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False)
    email = Column(String, unique=True, index=True)
    password = Column(String, nullable=False)
```

---

# ğŸ§© **3. `schemas.py` â€“ User Request & Response Schemas**

```python
# schemas.py
from pydantic import BaseModel, EmailStr

class UserCreate(BaseModel):
    name: str
    email: EmailStr
    password: str

class UserResponse(BaseModel):
    id: int
    name: str
    email: EmailStr

    class Config:
        orm_mode = True
```

---

# ğŸ§  **4. `db_user.py` â€“ Business Logic Layer (CRUD)**

```python
# db_user.py
from sqlalchemy.orm import Session
from models import User
from schemas import UserCreate
from utils import hash_password

def create_user(db: Session, user: UserCreate):
    db_user = User(
        name=user.name,
        email=user.email,
        password=hash_password(user.password)
    )
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user
```

---

# ğŸ” **(Optional) `utils.py` â€“ Password Hashing**

```python
# utils.py
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)
```

---

# ğŸš€ **5. `user.py` â€“ Route for Creating User**

```python
# user.py
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from database import get_db
from schemas import UserCreate, UserResponse
from db_user import create_user

router = APIRouter()

@router.post("/users/", response_model=UserResponse)
def register_user(user: UserCreate, db: Session = Depends(get_db)):
    return create_user(db, user)
```

---

# ğŸ§­ **6. `main.py` â€“ Mount Routers & Initialize DB**

```python
# main.py
from fastapi import FastAPI
import models
from database import engine
from user import router as user_router

models.Base.metadata.create_all(bind=engine)

app = FastAPI()

# Mount the user routes
app.include_router(user_router)
```

---

# âœ… Final Folder & File Structure

```
project/
â”œâ”€â”€ main.py
â”œâ”€â”€ models.py
â”œâ”€â”€ schemas.py
â”œâ”€â”€ db_user.py
â”œâ”€â”€ user.py
â”œâ”€â”€ database.py
â”œâ”€â”€ utils.py
â””â”€â”€ users.db (created on first run)
```

---

# ğŸ” Test the API

**ğŸ“¤ POST `/users/`**

```json
{
  "name": "Darshan",
  "email": "darshan@example.com",
  "password": "secret123"
}
```

**âœ… Response:**

```json
{
  "id": 1,
  "name": "Darshan",
  "email": "darshan@example.com"
}
```

---
