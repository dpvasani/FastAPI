<!DOCTYPE html>
<html>
<head>
<title>13. Complete FastAPI Production Guide Deployment, Debugging, Testing And Logging.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%F0%9F%9A%80-complete-fastapi-production-guide-deployment-debugging-testing--logging">ğŸš€ Complete FastAPI Production Guide: Deployment, Debugging, Testing &amp; Logging</h1>
<h2 id="%F0%9F%93%8B-table-of-contents">ğŸ“‹ Table of Contents</h2>
<ol>
<li><a href="#deployment">ğŸŒ Deployment</a></li>
<li><a href="#debugging">ğŸ› Debugging</a></li>
<li><a href="#testing">ğŸ§ª Testing</a></li>
<li><a href="#logging">ğŸ“Š Logging</a></li>
</ol>
<h2 id="%F0%9F%8C%90-deployment">ğŸŒ Deployment</h2>
<h3 id="%F0%9F%93%81-production-ready-project-structure">ğŸ“ Production-Ready Project Structure</h3>
<pre class="hljs"><code><div>fastapi-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ auth.py
â”‚   â”‚       â””â”€â”€ users.py
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py
â”‚   â”‚   â””â”€â”€ security.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user.py
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ user_service.py
â”œâ”€â”€ tests/
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ gunicorn.conf.py
â”œâ”€â”€ nginx.conf
â””â”€â”€ .env
</div></code></pre>
<h3 id="%E2%9A%99%EF%B8%8F-production-configuration">âš™ï¸ Production Configuration</h3>
<h4 id="environment-configuration">Environment Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/core/config.py</span>
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Settings</span><span class="hljs-params">(BaseSettings)</span>:</span>
    app_name: str = <span class="hljs-string">"FastAPI App"</span>
    debug: bool = <span class="hljs-literal">False</span>
    secret_key: str
    database_url: str
    redis_url: Optional[str] = <span class="hljs-literal">None</span>
    
    <span class="hljs-comment"># Security</span>
    access_token_expire_minutes: int = <span class="hljs-number">30</span>
    refresh_token_expire_days: int = <span class="hljs-number">7</span>
    
    <span class="hljs-comment"># CORS</span>
    allowed_hosts: list = [<span class="hljs-string">"*"</span>]
    
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>:</span>
        env_file = <span class="hljs-string">".env"</span>

settings = Settings()
</div></code></pre>
<h4 id="main-application-with-production-settings">Main Application with Production Settings</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/main.py</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request
<span class="hljs-keyword">from</span> fastapi.middleware.cors <span class="hljs-keyword">import</span> CORSMiddleware
<span class="hljs-keyword">from</span> fastapi.middleware.trustedhost <span class="hljs-keyword">import</span> TrustedHostMiddleware
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> app.core.config <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> app.api.v1 <span class="hljs-keyword">import</span> auth, users

<span class="hljs-comment"># Logger setup</span>
logger = logging.getLogger(__name__)

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lifespan</span><span class="hljs-params">(app: FastAPI)</span>:</span>
    <span class="hljs-string">"""Application startup and shutdown"""</span>
    <span class="hljs-comment"># Startup</span>
    logger.info(<span class="hljs-string">"ğŸš€ Starting FastAPI application..."</span>)
    <span class="hljs-keyword">yield</span>
    <span class="hljs-comment"># Shutdown</span>
    logger.info(<span class="hljs-string">"ğŸ”„ Shutting down FastAPI application..."</span>)

app = FastAPI(
    title=settings.app_name,
    description=<span class="hljs-string">"Production FastAPI Application"</span>,
    version=<span class="hljs-string">"1.0.0"</span>,
    debug=settings.debug,
    lifespan=lifespan,
    docs_url=<span class="hljs-string">"/docs"</span> <span class="hljs-keyword">if</span> settings.debug <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,  <span class="hljs-comment"># Disable docs in production</span>
    redoc_url=<span class="hljs-string">"/redoc"</span> <span class="hljs-keyword">if</span> settings.debug <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
)

<span class="hljs-comment"># Security Middleware</span>
app.add_middleware(
    TrustedHostMiddleware, 
    allowed_hosts=settings.allowed_hosts
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=[<span class="hljs-string">"*"</span>],  <span class="hljs-comment"># Configure properly for production</span>
    allow_credentials=<span class="hljs-literal">True</span>,
    allow_methods=[<span class="hljs-string">"*"</span>],
    allow_headers=[<span class="hljs-string">"*"</span>],
)

<span class="hljs-comment"># Health Check Endpoint</span>
<span class="hljs-meta">@app.get("/health", tags=["Health"])</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">health_check</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""ğŸ¥ Health check endpoint for load balancers"""</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"healthy"</span>, <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>}

<span class="hljs-comment"># Include Routers</span>
app.include_router(auth.router, prefix=<span class="hljs-string">"/api/v1"</span>, tags=[<span class="hljs-string">"Auth"</span>])
app.include_router(users.router, prefix=<span class="hljs-string">"/api/v1"</span>, tags=[<span class="hljs-string">"Users"</span>])
</div></code></pre>
<h3 id="%F0%9F%90%B3-docker-configuration">ğŸ³ Docker Configuration</h3>
<h4 id="dockerfile">Dockerfile</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">FROM</span> python:<span class="hljs-number">3.11</span>-slim

<span class="hljs-comment"># Set environment variables</span>
<span class="hljs-keyword">ENV</span> PYTHONUNBUFFERED=<span class="hljs-number">1</span> \
    PYTHONDONTWRITEBYTECODE=<span class="hljs-number">1</span> \
    PIP_NO_CACHE_DIR=<span class="hljs-number">1</span> \
    PIP_DISABLE_PIP_VERSION_CHECK=<span class="hljs-number">1</span>

<span class="hljs-comment"># Create app directory</span>
<span class="hljs-keyword">WORKDIR</span><span class="bash"> /app</span>

<span class="hljs-comment"># Install system dependencies</span>
<span class="hljs-keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y \
    gcc \
    &amp;&amp; rm -rf /var/lib/apt/lists/*</span>

<span class="hljs-comment"># Copy and install Python dependencies</span>
<span class="hljs-keyword">COPY</span><span class="bash"> requirements.txt .</span>
<span class="hljs-keyword">RUN</span><span class="bash"> pip install --no-cache-dir -r requirements.txt</span>

<span class="hljs-comment"># Copy application code</span>
<span class="hljs-keyword">COPY</span><span class="bash"> . .</span>

<span class="hljs-comment"># Create non-root user</span>
<span class="hljs-keyword">RUN</span><span class="bash"> useradd --create-home --shell /bin/bash app &amp;&amp; chown -R app:app /app</span>
<span class="hljs-keyword">USER</span> app

<span class="hljs-comment"># Health check</span>
<span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || <span class="hljs-built_in">exit</span> 1</span>

<span class="hljs-comment"># Expose port</span>
<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8000</span>

<span class="hljs-comment"># Run application</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">"gunicorn"</span>, <span class="hljs-string">"app.main:app"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"gunicorn.conf.py"</span>]</span>
</div></code></pre>
<h4 id="docker-compose">Docker Compose</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># docker-compose.yml</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8000:8000"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DATABASE_URL=postgresql://user:password@db:5432/fastapi_db</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">REDIS_URL=redis://redis:6379</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./logs:/app/logs</span>
    
  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:15</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">fastapi_db</span>
      <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">user</span>
      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">password</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">postgres_data:/var/lib/postgresql/data</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"5432:5432"</span>
  
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6379:6379"</span>
  
  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:alpine</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"80:80"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"443:443"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx.conf:/etc/nginx/nginx.conf</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">postgres_data:</span>
</div></code></pre>
<h3 id="%F0%9F%8C%90-production-server-configuration">ğŸŒ Production Server Configuration</h3>
<h4 id="gunicorn-configuration">Gunicorn Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># gunicorn.conf.py</span>
<span class="hljs-keyword">import</span> multiprocessing

<span class="hljs-comment"># Server socket</span>
bind = <span class="hljs-string">"0.0.0.0:8000"</span>
backlog = <span class="hljs-number">2048</span>

<span class="hljs-comment"># Worker processes</span>
workers = multiprocessing.cpu_count() * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>
worker_class = <span class="hljs-string">"uvicorn.workers.UvicornWorker"</span>
worker_connections = <span class="hljs-number">1000</span>
max_requests = <span class="hljs-number">1000</span>
max_requests_jitter = <span class="hljs-number">100</span>

<span class="hljs-comment"># Timeout</span>
timeout = <span class="hljs-number">30</span>
keepalive = <span class="hljs-number">2</span>

<span class="hljs-comment"># Logging</span>
accesslog = <span class="hljs-string">"/app/logs/access.log"</span>
errorlog = <span class="hljs-string">"/app/logs/error.log"</span>
loglevel = <span class="hljs-string">"info"</span>
access_log_format = <span class="hljs-string">'%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'</span>

<span class="hljs-comment"># Process naming</span>
proc_name = <span class="hljs-string">"fastapi-app"</span>

<span class="hljs-comment"># Server mechanics</span>
preload_app = <span class="hljs-literal">True</span>
daemon = <span class="hljs-literal">False</span>
pidfile = <span class="hljs-string">"/app/gunicorn.pid"</span>
user = <span class="hljs-string">"app"</span>
group = <span class="hljs-string">"app"</span>

<span class="hljs-comment"># SSL (if needed)</span>
<span class="hljs-comment"># keyfile = "/path/to/keyfile"</span>
<span class="hljs-comment"># certfile = "/path/to/certfile"</span>
</div></code></pre>
<h4 id="nginx-configuration">Nginx Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># nginx.conf</span>
<span class="hljs-section">events</span> {
    <span class="hljs-attribute">worker_connections</span> <span class="hljs-number">1024</span>;
}

<span class="hljs-section">http</span> {
    <span class="hljs-attribute">include</span>       /etc/nginx/mime.types;
    <span class="hljs-attribute">default_type</span>  application/octet-stream;
    
    <span class="hljs-comment"># Logging</span>
    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;
    
    <span class="hljs-comment"># Gzip compression</span>
    <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">gzip_vary</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">gzip_min_length</span> <span class="hljs-number">1024</span>;
    <span class="hljs-attribute">gzip_types</span> text/plain text/css text/xml text/javascript 
               application/json application/javascript 
               application/xml+rss application/atom+xml;
    
    <span class="hljs-comment"># Rate limiting</span>
    <span class="hljs-attribute">limit_req_zone</span> <span class="hljs-variable">$binary_remote_addr</span> zone=api:<span class="hljs-number">10m</span> rate=10r/s;
    
    <span class="hljs-attribute">upstream</span> fastapi_backend {
        <span class="hljs-attribute">server</span> app:<span class="hljs-number">8000</span>;
        <span class="hljs-comment"># Add more servers for load balancing</span>
        <span class="hljs-comment"># server app2:8000;</span>
    }
    
    <span class="hljs-section">server</span> {
        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
        <span class="hljs-attribute">server_name</span> yourdomain.com;
        
        <span class="hljs-comment"># Rate limiting</span>
        <span class="hljs-attribute">limit_req</span> zone=api burst=<span class="hljs-number">20</span> nodelay;
        
        <span class="hljs-comment"># Security headers</span>
        <span class="hljs-attribute">add_header</span> X-Content-Type-Options nosniff;
        <span class="hljs-attribute">add_header</span> X-Frame-Options DENY;
        <span class="hljs-attribute">add_header</span> X-XSS-Protection <span class="hljs-string">"1; mode=block"</span>;
        
        <span class="hljs-comment"># Proxy settings</span>
        <span class="hljs-attribute">location</span> / {
            <span class="hljs-attribute">proxy_pass</span> http://fastapi_backend;
            <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
            <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
            <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
            <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;
        }
        
        <span class="hljs-comment"># Static files (if any)</span>
        <span class="hljs-attribute">location</span> /static/ {
            <span class="hljs-attribute">alias</span> /app/static/;
            <span class="hljs-attribute">expires</span> <span class="hljs-number">30d</span>;
            <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">"public, immutable"</span>;
        }
    }
}
</div></code></pre>
<h3 id="%E2%98%81%EF%B8%8F-cloud-deployment-examples">â˜ï¸ Cloud Deployment Examples</h3>
<h4 id="heroku-deployment">Heroku Deployment</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Procfile</span>
<span class="hljs-attr">web:</span> <span class="hljs-string">gunicorn</span> <span class="hljs-string">app.main:app</span> <span class="hljs-string">-c</span> <span class="hljs-string">gunicorn.conf.py</span>

<span class="hljs-comment"># runtime.txt</span>
<span class="hljs-string">python-3.11.0</span>
</div></code></pre>
<h4 id="railway-deployment">Railway Deployment</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// railway.json</span>
{
  <span class="hljs-attr">"build"</span>: {
    <span class="hljs-attr">"builder"</span>: <span class="hljs-string">"DOCKERFILE"</span>
  },
  <span class="hljs-attr">"deploy"</span>: {
    <span class="hljs-attr">"startCommand"</span>: <span class="hljs-string">"gunicorn app.main:app -c gunicorn.conf.py"</span>,
    <span class="hljs-attr">"healthcheckPath"</span>: <span class="hljs-string">"/health"</span>
  }
}
</div></code></pre>
<h2 id="%F0%9F%90%9B-debugging">ğŸ› Debugging</h2>
<h3 id="%F0%9F%94%A7-debug-mode-configuration">ğŸ”§ Debug Mode Configuration</h3>
<h4 id="enable-debug-mode">Enable Debug Mode</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/main.py</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">import</span> logging

<span class="hljs-comment"># Configure debug mode</span>
DEBUG = os.getenv(<span class="hljs-string">"DEBUG"</span>, <span class="hljs-string">"false"</span>).lower() == <span class="hljs-string">"true"</span>

app = FastAPI(
    debug=DEBUG,
    title=<span class="hljs-string">"FastAPI Debug App"</span>
)

<span class="hljs-keyword">if</span> DEBUG:
    logging.basicConfig(level=logging.DEBUG)
    logger = logging.getLogger(__name__)
    logger.debug(<span class="hljs-string">"ğŸ› Debug mode enabled!"</span>)

<span class="hljs-meta">@app.get("/debug-info")</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug_info</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Debug endpoint - only available in debug mode"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> DEBUG:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Debug info not available in production"</span>}
    
    <span class="hljs-keyword">import</span> sys
    <span class="hljs-keyword">import</span> platform
    
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"python_version"</span>: sys.version,
        <span class="hljs-string">"platform"</span>: platform.platform(),
        <span class="hljs-string">"debug_mode"</span>: DEBUG,
        <span class="hljs-string">"environment"</span>: os.environ.get(<span class="hljs-string">"ENVIRONMENT"</span>, <span class="hljs-string">"development"</span>)
    }
</div></code></pre>
<h3 id="%F0%9F%94%8D-interactive-debugging">ğŸ” Interactive Debugging</h3>
<h4 id="using-pdb-python-debugger">Using PDB (Python Debugger)</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> pdb

<span class="hljs-meta">@app.get("/users/{user_id}")</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user</span><span class="hljs-params">(user_id: int)</span>:</span>
    <span class="hljs-comment"># Set breakpoint for debugging</span>
    pdb.set_trace()  <span class="hljs-comment"># ğŸ›‘ Execution will pause here</span>
    
    user = <span class="hljs-keyword">await</span> get_user_from_db(user_id)
    <span class="hljs-keyword">return</span> user
</div></code></pre>
<h4 id="using-debugpy-for-remote-debugging">Using Debugpy for Remote Debugging</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Remote debugging setup</span>
<span class="hljs-keyword">import</span> debugpy
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">if</span> os.getenv(<span class="hljs-string">"ENABLE_DEBUGPY"</span>, <span class="hljs-string">"false"</span>).lower() == <span class="hljs-string">"true"</span>:
    debugpy.listen((<span class="hljs-string">"0.0.0.0"</span>, <span class="hljs-number">5678</span>))
    print(<span class="hljs-string">"âš¡ Waiting for debugger to attach..."</span>)
    debugpy.wait_for_client()

<span class="hljs-meta">@app.get("/")</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># Set breakpoint here in your IDE</span>
    message = <span class="hljs-string">"Hello Debug World!"</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: message}
</div></code></pre>
<h3 id="%F0%9F%93%9D-advanced-debugging-with-middleware">ğŸ“ Advanced Debugging with Middleware</h3>
<h4 id="requestresponse-debug-middleware">Request/Response Debug Middleware</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> starlette.middleware.base <span class="hljs-keyword">import</span> BaseHTTPMiddleware
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> json

logger = logging.getLogger(__name__)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DebugMiddleware</span><span class="hljs-params">(BaseHTTPMiddleware)</span>:</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(self, request, call_next)</span>:</span>
        start_time = time.time()
        
        <span class="hljs-comment"># Log request details</span>
        logger.debug(<span class="hljs-string">f"ğŸ”µ Request: <span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.url}</span>"</span>)
        logger.debug(<span class="hljs-string">f"ğŸ”µ Headers: <span class="hljs-subst">{dict(request.headers)}</span>"</span>)
        
        <span class="hljs-comment"># Get request body for debugging</span>
        <span class="hljs-keyword">if</span> request.method <span class="hljs-keyword">in</span> [<span class="hljs-string">"POST"</span>, <span class="hljs-string">"PUT"</span>, <span class="hljs-string">"PATCH"</span>]:
            body = <span class="hljs-keyword">await</span> request.body()
            logger.debug(<span class="hljs-string">f"ğŸ”µ Body: <span class="hljs-subst">{body.decode() <span class="hljs-keyword">if</span> body <span class="hljs-keyword">else</span> <span class="hljs-string">'Empty'</span>}</span>"</span>)
        
        response = <span class="hljs-keyword">await</span> call_next(request)
        
        process_time = time.time() - start_time
        logger.debug(<span class="hljs-string">f"ğŸ”µ Response: <span class="hljs-subst">{response.status_code}</span> - <span class="hljs-subst">{process_time:<span class="hljs-number">.4</span>f}</span>s"</span>)
        
        <span class="hljs-keyword">return</span> response

<span class="hljs-comment"># Add middleware only in debug mode</span>
<span class="hljs-keyword">if</span> DEBUG:
    app.add_middleware(DebugMiddleware)
</div></code></pre>
<h3 id="%F0%9F%9A%A8-exception-handling--error-tracking">ğŸš¨ Exception Handling &amp; Error Tracking</h3>
<h4 id="custom-exception-handler">Custom Exception Handler</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Request, HTTPException
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">import</span> logging

logger = logging.getLogger(__name__)

<span class="hljs-meta">@app.exception_handler(Exception)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">global_exception_handler</span><span class="hljs-params">(request: Request, exc: Exception)</span>:</span>
    <span class="hljs-string">"""ğŸš¨ Global exception handler for debugging"""</span>
    
    <span class="hljs-comment"># Log the full traceback</span>
    logger.error(<span class="hljs-string">f"âŒ Unhandled exception: <span class="hljs-subst">{exc}</span>"</span>)
    logger.error(<span class="hljs-string">f"âŒ Traceback: <span class="hljs-subst">{traceback.format_exc()}</span>"</span>)
    logger.error(<span class="hljs-string">f"âŒ Request: <span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.url}</span>"</span>)
    
    <span class="hljs-keyword">if</span> DEBUG:
        <span class="hljs-comment"># Return detailed error in debug mode</span>
        <span class="hljs-keyword">return</span> JSONResponse(
            status_code=<span class="hljs-number">500</span>,
            content={
                <span class="hljs-string">"error"</span>: str(exc),
                <span class="hljs-string">"type"</span>: type(exc).__name__,
                <span class="hljs-string">"traceback"</span>: traceback.format_exc().split(<span class="hljs-string">"\n"</span>)
            }
        )
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># Generic error in production</span>
        <span class="hljs-keyword">return</span> JSONResponse(
            status_code=<span class="hljs-number">500</span>,
            content={<span class="hljs-string">"error"</span>: <span class="hljs-string">"Internal server error"</span>}
        )

<span class="hljs-meta">@app.exception_handler(HTTPException)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">http_exception_handler</span><span class="hljs-params">(request: Request, exc: HTTPException)</span>:</span>
    <span class="hljs-string">"""ğŸš¨ HTTP exception handler"""</span>
    logger.warning(<span class="hljs-string">f"âš ï¸ HTTP Exception: <span class="hljs-subst">{exc.status_code}</span> - <span class="hljs-subst">{exc.detail}</span>"</span>)
    logger.warning(<span class="hljs-string">f"âš ï¸ Request: <span class="hljs-subst">{request.method}</span> <span class="hljs-subst">{request.url}</span>"</span>)
    
    <span class="hljs-keyword">return</span> JSONResponse(
        status_code=exc.status_code,
        content={<span class="hljs-string">"error"</span>: exc.detail, <span class="hljs-string">"status_code"</span>: exc.status_code}
    )
</div></code></pre>
<h3 id="%F0%9F%94%8D-debugging-async-code">ğŸ” Debugging Async Code</h3>
<h4 id="async-debugging-tools">Async Debugging Tools</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiomonitor

<span class="hljs-comment"># Monitor async tasks</span>
<span class="hljs-meta">@app.on_event("startup")</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start_monitoring</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">if</span> DEBUG:
        <span class="hljs-comment"># Start async monitor</span>
        aiomonitor.start_monitor(loop=asyncio.get_event_loop())
        logger.debug(<span class="hljs-string">"ğŸ” Async monitor started"</span>)

<span class="hljs-meta">@app.get("/async-debug")</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">async_debug_example</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Example of debugging async operations"""</span>
    logger.debug(<span class="hljs-string">"ğŸ”„ Starting async operation"</span>)
    
    <span class="hljs-comment"># Simulate async work</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># Check current running tasks</span>
    current_task = asyncio.current_task()
    all_tasks = asyncio.all_tasks()
    
    logger.debug(<span class="hljs-string">f"ğŸ”„ Current task: <span class="hljs-subst">{current_task}</span>"</span>)
    logger.debug(<span class="hljs-string">f"ğŸ”„ Total tasks: <span class="hljs-subst">{len(all_tasks)}</span>"</span>)
    
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"current_task"</span>: str(current_task),
        <span class="hljs-string">"total_tasks"</span>: len(all_tasks),
        <span class="hljs-string">"task_names"</span>: [task.get_name() <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> all_tasks]
    }
</div></code></pre>
<h3 id="%F0%9F%93%8A-performance-debugging">ğŸ“Š Performance Debugging</h3>
<h4 id="performance-profiling-middleware">Performance Profiling Middleware</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> cProfile
<span class="hljs-keyword">import</span> pstats
<span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProfilingMiddleware</span><span class="hljs-params">(BaseHTTPMiddleware)</span>:</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(self, request, call_next)</span>:</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> DEBUG:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> call_next(request)
        
        <span class="hljs-comment"># Start profiling</span>
        profiler = cProfile.Profile()
        profiler.enable()
        
        response = <span class="hljs-keyword">await</span> call_next(request)
        
        <span class="hljs-comment"># Stop profiling</span>
        profiler.disable()
        
        <span class="hljs-comment"># Get stats</span>
        stats_stream = StringIO()
        stats = pstats.Stats(profiler, stream=stats_stream)
        stats.sort_stats(<span class="hljs-string">'cumulative'</span>)
        stats.print_stats(<span class="hljs-number">20</span>)  <span class="hljs-comment"># Top 20 functions</span>
        
        <span class="hljs-comment"># Log performance stats</span>
        logger.debug(<span class="hljs-string">f"ğŸ“Š Performance Stats for <span class="hljs-subst">{request.url}</span>:\n<span class="hljs-subst">{stats_stream.getvalue()}</span>"</span>)
        
        <span class="hljs-keyword">return</span> response

<span class="hljs-keyword">if</span> DEBUG:
    app.add_middleware(ProfilingMiddleware)
</div></code></pre>
<h2 id="%F0%9F%A7%AA-testing">ğŸ§ª Testing</h2>
<h3 id="%F0%9F%8F%97%EF%B8%8F-testing-setup--structure">ğŸ—ï¸ Testing Setup &amp; Structure</h3>
<h4 id="test-configuration">Test Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># tests/conftest.py</span>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> fastapi.testclient <span class="hljs-keyword">import</span> TestClient
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> sessionmaker
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> httpx <span class="hljs-keyword">import</span> AsyncClient

<span class="hljs-keyword">from</span> app.main <span class="hljs-keyword">import</span> app
<span class="hljs-keyword">from</span> app.database <span class="hljs-keyword">import</span> Base, get_db

<span class="hljs-comment"># Test database</span>
SQLALCHEMY_DATABASE_URL = <span class="hljs-string">"sqlite:///./test.db"</span>
engine = create_engine(SQLALCHEMY_DATABASE_URL, connect_args={<span class="hljs-string">"check_same_thread"</span>: <span class="hljs-literal">False</span>})
TestingSessionLocal = sessionmaker(autocommit=<span class="hljs-literal">False</span>, autoflush=<span class="hljs-literal">False</span>, bind=engine)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">override_get_db</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Override database dependency for testing"""</span>
    <span class="hljs-keyword">try</span>:
        db = TestingSessionLocal()
        <span class="hljs-keyword">yield</span> db
    <span class="hljs-keyword">finally</span>:
        db.close()

app.dependency_overrides[get_db] = override_get_db

<span class="hljs-meta">@pytest.fixture(scope="session")</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">event_loop</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Create event loop for async tests"""</span>
    loop = asyncio.get_event_loop_policy().new_event_loop()
    <span class="hljs-keyword">yield</span> loop
    loop.close()

<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">client</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Test client fixture"""</span>
    <span class="hljs-keyword">with</span> TestClient(app) <span class="hljs-keyword">as</span> test_client:
        <span class="hljs-keyword">yield</span> test_client

<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">async_client</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Async test client fixture"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncClient(app=app, base_url=<span class="hljs-string">"http://test"</span>) <span class="hljs-keyword">as</span> ac:
        <span class="hljs-keyword">yield</span> ac

<span class="hljs-meta">@pytest.fixture(autouse=True)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_test_database</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Create test database before each test"""</span>
    Base.metadata.create_all(bind=engine)
    <span class="hljs-keyword">yield</span>
    Base.metadata.drop_all(bind=engine)
</div></code></pre>
<h3 id="%F0%9F%A7%AA-unit-testing">ğŸ§ª Unit Testing</h3>
<h4 id="basic-unit-tests">Basic Unit Tests</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># tests/test_main.py</span>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> fastapi.testclient <span class="hljs-keyword">import</span> TestClient
<span class="hljs-keyword">from</span> app.main <span class="hljs-keyword">import</span> app

client = TestClient(app)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_health_check</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""ğŸ¥ Test health check endpoint"""</span>
    response = client.get(<span class="hljs-string">"/health"</span>)
    <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">200</span>
    <span class="hljs-keyword">assert</span> response.json() == {<span class="hljs-string">"status"</span>: <span class="hljs-string">"healthy"</span>, <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>}

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_root_endpoint</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""ğŸ  Test root endpoint"""</span>
    response = client.get(<span class="hljs-string">"/"</span>)
    <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">200</span>
    <span class="hljs-keyword">assert</span> <span class="hljs-string">"message"</span> <span class="hljs-keyword">in</span> response.json()

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestUserEndpoints</span>:</span>
    <span class="hljs-string">"""ğŸ‘¥ User endpoint tests"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_user</span><span class="hljs-params">(self, client)</span>:</span>
        <span class="hljs-string">"""âœ¨ Test user creation"""</span>
        user_data = {
            <span class="hljs-string">"username"</span>: <span class="hljs-string">"testuser"</span>,
            <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"TestPass123"</span>,
            <span class="hljs-string">"full_name"</span>: <span class="hljs-string">"Test User"</span>
        }
        
        response = client.post(<span class="hljs-string">"/api/v1/users/register"</span>, json=user_data)
        
        <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">201</span>
        data = response.json()
        <span class="hljs-keyword">assert</span> data[<span class="hljs-string">"success"</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">assert</span> data[<span class="hljs-string">"user"</span>][<span class="hljs-string">"username"</span>] == user_data[<span class="hljs-string">"username"</span>]
        <span class="hljs-keyword">assert</span> data[<span class="hljs-string">"user"</span>][<span class="hljs-string">"email"</span>] == user_data[<span class="hljs-string">"email"</span>]
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_user_duplicate_email</span><span class="hljs-params">(self, client)</span>:</span>
        <span class="hljs-string">"""âŒ Test duplicate email validation"""</span>
        user_data = {
            <span class="hljs-string">"username"</span>: <span class="hljs-string">"testuser"</span>,
            <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"TestPass123"</span>,
            <span class="hljs-string">"full_name"</span>: <span class="hljs-string">"Test User"</span>
        }
        
        <span class="hljs-comment"># Create first user</span>
        client.post(<span class="hljs-string">"/api/v1/users/register"</span>, json=user_data)
        
        <span class="hljs-comment"># Try to create second user with same email</span>
        user_data[<span class="hljs-string">"username"</span>] = <span class="hljs-string">"testuser2"</span>
        response = client.post(<span class="hljs-string">"/api/v1/users/register"</span>, json=user_data)
        
        <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">400</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"already registered"</span> <span class="hljs-keyword">in</span> response.json()[<span class="hljs-string">"detail"</span>]
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_login_user</span><span class="hljs-params">(self, client)</span>:</span>
        <span class="hljs-string">"""ğŸ” Test user login"""</span>
        <span class="hljs-comment"># First create a user</span>
        user_data = {
            <span class="hljs-string">"username"</span>: <span class="hljs-string">"testuser"</span>,
            <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"TestPass123"</span>,
            <span class="hljs-string">"full_name"</span>: <span class="hljs-string">"Test User"</span>
        }
        client.post(<span class="hljs-string">"/api/v1/users/register"</span>, json=user_data)
        
        <span class="hljs-comment"># Then login</span>
        login_data = {
            <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"TestPass123"</span>
        }
        
        response = client.post(<span class="hljs-string">"/api/v1/auth/login"</span>, json=login_data)
        
        <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">200</span>
        data = response.json()
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"access_token"</span> <span class="hljs-keyword">in</span> data
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"refresh_token"</span> <span class="hljs-keyword">in</span> data
        <span class="hljs-keyword">assert</span> data[<span class="hljs-string">"token_type"</span>] == <span class="hljs-string">"bearer"</span>
</div></code></pre>
<h3 id="%F0%9F%94%84-async-testing">ğŸ”„ Async Testing</h3>
<h4 id="async-test-examples">Async Test Examples</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># tests/test_async_endpoints.py</span>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> httpx <span class="hljs-keyword">import</span> AsyncClient
<span class="hljs-keyword">from</span> app.main <span class="hljs-keyword">import</span> app

<span class="hljs-meta">@pytest.mark.asyncio</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_async_endpoint</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""ğŸ”„ Test async endpoint"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncClient(app=app, base_url=<span class="hljs-string">"http://test"</span>) <span class="hljs-keyword">as</span> ac:
        response = <span class="hljs-keyword">await</span> ac.get(<span class="hljs-string">"/async-endpoint"</span>)
        <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">200</span>

<span class="hljs-meta">@pytest.mark.asyncio</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_concurrent_requests</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""âš¡ Test concurrent requests"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncClient(app=app, base_url=<span class="hljs-string">"http://test"</span>) <span class="hljs-keyword">as</span> ac:
        <span class="hljs-comment"># Create multiple concurrent requests</span>
        tasks = [
            ac.get(<span class="hljs-string">f"/users/<span class="hljs-subst">{i}</span>"</span>) 
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">11</span>)
        ]
        
        responses = <span class="hljs-keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="hljs-literal">True</span>)
        
        <span class="hljs-comment"># Verify all requests completed</span>
        <span class="hljs-keyword">assert</span> len(responses) == <span class="hljs-number">10</span>
        successful_responses = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> responses <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(r, Exception)]
        <span class="hljs-keyword">assert</span> len(successful_responses) &gt; <span class="hljs-number">0</span>
</div></code></pre>
<h3 id="%F0%9F%A7%AA-integration-testing">ğŸ§ª Integration Testing</h3>
<h4 id="database-integration-tests">Database Integration Tests</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># tests/test_database_integration.py</span>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> app.models.user <span class="hljs-keyword">import</span> UserInDB
<span class="hljs-keyword">from</span> app.services.user_service <span class="hljs-keyword">import</span> UserService

<span class="hljs-meta">@pytest.mark.asyncio</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_user_crud_operations</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""ğŸ“Š Test complete CRUD operations"""</span>
    user_service = UserService()
    
    <span class="hljs-comment"># Create user</span>
    user_data = {
        <span class="hljs-string">"username"</span>: <span class="hljs-string">"testuser"</span>,
        <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>, 
        <span class="hljs-string">"password"</span>: <span class="hljs-string">"TestPass123"</span>,
        <span class="hljs-string">"full_name"</span>: <span class="hljs-string">"Test User"</span>
    }
    
    <span class="hljs-comment"># Test Create</span>
    created_user = <span class="hljs-keyword">await</span> user_service.create_user(user_data)
    <span class="hljs-keyword">assert</span> created_user.username == user_data[<span class="hljs-string">"username"</span>]
    <span class="hljs-keyword">assert</span> created_user.email == user_data[<span class="hljs-string">"email"</span>]
    
    <span class="hljs-comment"># Test Read</span>
    retrieved_user = <span class="hljs-keyword">await</span> user_service.get_user_by_email(user_data[<span class="hljs-string">"email"</span>])
    <span class="hljs-keyword">assert</span> retrieved_user <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">assert</span> retrieved_user.id == created_user.id
    
    <span class="hljs-comment"># Test Update</span>
    update_data = {<span class="hljs-string">"full_name"</span>: <span class="hljs-string">"Updated User"</span>}
    updated_user = <span class="hljs-keyword">await</span> user_service.update_user(created_user.id, update_data)
    <span class="hljs-keyword">assert</span> updated_user.full_name == <span class="hljs-string">"Updated User"</span>
    
    <span class="hljs-comment"># Test Delete</span>
    deleted = <span class="hljs-keyword">await</span> user_service.delete_user(created_user.id)
    <span class="hljs-keyword">assert</span> deleted <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
    
    <span class="hljs-comment"># Verify deletion</span>
    deleted_user = <span class="hljs-keyword">await</span> user_service.get_user_by_id(created_user.id)
    <span class="hljs-keyword">assert</span> deleted_user <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>
</div></code></pre>
<h3 id="%F0%9F%94%92-security-testing">ğŸ”’ Security Testing</h3>
<h4 id="authentication--authorization-tests">Authentication &amp; Authorization Tests</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># tests/test_security.py</span>
<span class="hljs-keyword">import</span> jwt
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> app.core.security <span class="hljs-keyword">import</span> create_access_token, verify_token

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestAuthentication</span>:</span>
    <span class="hljs-string">"""ğŸ”’ Authentication tests"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_access_token</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ğŸ« Test token creation"""</span>
        user_data = {<span class="hljs-string">"sub"</span>: <span class="hljs-string">"user123"</span>, <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>}
        token = create_access_token(user_data)
        
        <span class="hljs-keyword">assert</span> isinstance(token, str)
        <span class="hljs-keyword">assert</span> len(token) &gt; <span class="hljs-number">0</span>
        
        <span class="hljs-comment"># Decode and verify</span>
        decoded = jwt.decode(token, options={<span class="hljs-string">"verify_signature"</span>: <span class="hljs-literal">False</span>})
        <span class="hljs-keyword">assert</span> decoded[<span class="hljs-string">"sub"</span>] == <span class="hljs-string">"user123"</span>
        <span class="hljs-keyword">assert</span> decoded[<span class="hljs-string">"email"</span>] == <span class="hljs-string">"test@example.com"</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_protected_endpoint_without_token</span><span class="hljs-params">(self, client)</span>:</span>
        <span class="hljs-string">"""ğŸš« Test protected endpoint without token"""</span>
        response = client.get(<span class="hljs-string">"/api/v1/users/me"</span>)
        <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">401</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_protected_endpoint_with_invalid_token</span><span class="hljs-params">(self, client)</span>:</span>
        <span class="hljs-string">"""âŒ Test protected endpoint with invalid token"""</span>
        headers = {<span class="hljs-string">"Authorization"</span>: <span class="hljs-string">"Bearer invalid_token"</span>}
        response = client.get(<span class="hljs-string">"/api/v1/users/me"</span>, headers=headers)
        <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">401</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_protected_endpoint_with_valid_token</span><span class="hljs-params">(self, client)</span>:</span>
        <span class="hljs-string">"""âœ… Test protected endpoint with valid token"""</span>
        <span class="hljs-comment"># First create and login user</span>
        user_data = {
            <span class="hljs-string">"username"</span>: <span class="hljs-string">"testuser"</span>,
            <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"TestPass123"</span>,
            <span class="hljs-string">"full_name"</span>: <span class="hljs-string">"Test User"</span>
        }
        client.post(<span class="hljs-string">"/api/v1/users/register"</span>, json=user_data)
        
        login_response = client.post(<span class="hljs-string">"/api/v1/auth/login"</span>, json={
            <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"TestPass123"</span>
        })
        
        token = login_response.json()[<span class="hljs-string">"access_token"</span>]
        headers = {<span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{token}</span>"</span>}
        
        response = client.get(<span class="hljs-string">"/api/v1/users/me"</span>, headers=headers)
        <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">200</span>
        <span class="hljs-keyword">assert</span> response.json()[<span class="hljs-string">"user"</span>][<span class="hljs-string">"email"</span>] == <span class="hljs-string">"test@example.com"</span>
</div></code></pre>
<h3 id="%F0%9F%A7%AA-test-coverage--reporting">ğŸ§ª Test Coverage &amp; Reporting</h3>
<h4 id="pytest-configuration">Pytest Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># pytest.ini</span>
<span class="hljs-section">[tool:pytest]</span>
<span class="hljs-attr">testpaths</span> = tests
<span class="hljs-attr">python_files</span> = test_*.py
<span class="hljs-attr">python_classes</span> = Test*
<span class="hljs-attr">python_functions</span> = test_*
<span class="hljs-attr">addopts</span> = 
    --verbose
    --tb=short
    --cov=app
    --cov-report=html
    --cov-report=term-missing
    --cov-fail-under=80
    -p no:warnings

<span class="hljs-attr">markers</span> =
    unit: Unit tests
    integration: Integration tests
    slow: Slow tests
    security: Security tests
</div></code></pre>
<h4 id="coverage-configuration">Coverage Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># .coveragerc</span>
<span class="hljs-section">[run]</span>
<span class="hljs-attr">source</span> = app
<span class="hljs-attr">omit</span> = 
    */tests/*
    */venv/*
    */__pycache__/*
    */migrations/*

<span class="hljs-section">[report]</span>
<span class="hljs-attr">exclude_lines</span> =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
</div></code></pre>
<h3 id="%F0%9F%9A%80-performance-testing">ğŸš€ Performance Testing</h3>
<h4 id="load-testing-with-locust">Load Testing with Locust</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># tests/load_test.py</span>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpUser, task, between

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FastAPIUser</span><span class="hljs-params">(HttpUser)</span>:</span>
    wait_time = between(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_start</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Login and get token"""</span>
        response = self.client.post(<span class="hljs-string">"/api/v1/auth/login"</span>, json={
            <span class="hljs-string">"email"</span>: <span class="hljs-string">"test@example.com"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"TestPass123"</span>
        })
        
        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
            self.token = response.json()[<span class="hljs-string">"access_token"</span>]
            self.headers = {<span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{self.token}</span>"</span>}
    
<span class="hljs-meta">    @task(3)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_users</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ğŸƒ Load test user listing"""</span>
        self.client.get(<span class="hljs-string">"/api/v1/users/"</span>, headers=self.headers)
    
<span class="hljs-meta">    @task(2)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_profile</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""ğŸ‘¤ Load test user profile"""</span>
        self.client.get(<span class="hljs-string">"/api/v1/users/me"</span>, headers=self.headers)
    
<span class="hljs-meta">    @task(1)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_user</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""âœï¸ Load test user update"""</span>
        self.client.put(<span class="hljs-string">"/api/v1/users/update-account"</span>, 
                       json={<span class="hljs-string">"full_name"</span>: <span class="hljs-string">"Load Test User"</span>},
                       headers=self.headers)
</div></code></pre>
<h2 id="%F0%9F%93%8A-logging">ğŸ“Š Logging</h2>
<h3 id="%F0%9F%93%9D-basic-logging-setup">ğŸ“ Basic Logging Setup</h3>
<h4 id="structured-logging-configuration">Structured Logging Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/core/logging.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> logging.config <span class="hljs-keyword">import</span> dictConfig
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Any

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup_logging</span><span class="hljs-params">()</span> -&gt; Dict[str, Any]:</span>
    <span class="hljs-string">"""ğŸ”§ Configure logging for the application"""</span>
    
    log_level = os.getenv(<span class="hljs-string">"LOG_LEVEL"</span>, <span class="hljs-string">"INFO"</span>).upper()
    
    logging_config = {
        <span class="hljs-string">"version"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"disable_existing_loggers"</span>: <span class="hljs-literal">False</span>,
        <span class="hljs-string">"formatters"</span>: {
            <span class="hljs-string">"default"</span>: {
                <span class="hljs-string">"format"</span>: <span class="hljs-string">"%(asctime)s | %(levelname)-8s | %(name)s:%(lineno)d | %(message)s"</span>,
                <span class="hljs-string">"datefmt"</span>: <span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>,
            },
            <span class="hljs-string">"json"</span>: {
                <span class="hljs-string">"format"</span>: <span class="hljs-string">'{"timestamp": "%(asctime)s", "level": "%(levelname)s", "logger": "%(name)s", "line": %(lineno)d, "message": "%(message)s"}'</span>,
                <span class="hljs-string">"datefmt"</span>: <span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>,
            },
            <span class="hljs-string">"detailed"</span>: {
                <span class="hljs-string">"format"</span>: <span class="hljs-string">"%(asctime)s | %(levelname)-8s | %(name)s:%(lineno)d | %(funcName)s() | %(message)s"</span>,
                <span class="hljs-string">"datefmt"</span>: <span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>,
            }
        },
        <span class="hljs-string">"handlers"</span>: {
            <span class="hljs-string">"console"</span>: {
                <span class="hljs-string">"class"</span>: <span class="hljs-string">"logging.StreamHandler"</span>,
                <span class="hljs-string">"level"</span>: log_level,
                <span class="hljs-string">"formatter"</span>: <span class="hljs-string">"default"</span>,
                <span class="hljs-string">"stream"</span>: sys.stdout,
            },
            <span class="hljs-string">"file"</span>: {
                <span class="hljs-string">"class"</span>: <span class="hljs-string">"logging.handlers.RotatingFileHandler"</span>,
                <span class="hljs-string">"level"</span>: log_level,
                <span class="hljs-string">"formatter"</span>: <span class="hljs-string">"detailed"</span>,
                <span class="hljs-string">"filename"</span>: <span class="hljs-string">"logs/app.log"</span>,
                <span class="hljs-string">"maxBytes"</span>: <span class="hljs-number">10485760</span>,  <span class="hljs-comment"># 10MB</span>
                <span class="hljs-string">"backupCount"</span>: <span class="hljs-number">5</span>,
                <span class="hljs-string">"encoding"</span>: <span class="hljs-string">"utf8"</span>,
            },
            <span class="hljs-string">"error_file"</span>: {
                <span class="hljs-string">"class"</span>: <span class="hljs-string">"logging.handlers.RotatingFileHandler"</span>,
                <span class="hljs-string">"level"</span>: <span class="hljs-string">"ERROR"</span>,
                <span class="hljs-string">"formatter"</span>: <span class="hljs-string">"json"</span>,
                <span class="hljs-string">"filename"</span>: <span class="hljs-string">"logs/errors.log"</span>,
                <span class="hljs-string">"maxBytes"</span>: <span class="hljs-number">10485760</span>,  <span class="hljs-comment"># 10MB</span>
                <span class="hljs-string">"backupCount"</span>: <span class="hljs-number">5</span>,
                <span class="hljs-string">"encoding"</span>: <span class="hljs-string">"utf8"</span>,
            },
        },
        <span class="hljs-string">"loggers"</span>: {
            <span class="hljs-string">""</span>: {  <span class="hljs-comment"># Root logger</span>
                <span class="hljs-string">"handlers"</span>: [<span class="hljs-string">"console"</span>, <span class="hljs-string">"file"</span>],
                <span class="hljs-string">"level"</span>: log_level,
                <span class="hljs-string">"propagate"</span>: <span class="hljs-literal">False</span>,
            },
            <span class="hljs-string">"uvicorn"</span>: {
                <span class="hljs-string">"handlers"</span>: [<span class="hljs-string">"console"</span>],
                <span class="hljs-string">"level"</span>: <span class="hljs-string">"INFO"</span>,
                <span class="hljs-string">"propagate"</span>: <span class="hljs-literal">False</span>,
            },
            <span class="hljs-string">"uvicorn.access"</span>: {
                <span class="hljs-string">"handlers"</span>: [<span class="hljs-string">"file"</span>],
                <span class="hljs-string">"level"</span>: <span class="hljs-string">"INFO"</span>, 
                <span class="hljs-string">"propagate"</span>: <span class="hljs-literal">False</span>,
            },
            <span class="hljs-string">"app"</span>: {
                <span class="hljs-string">"handlers"</span>: [<span class="hljs-string">"console"</span>, <span class="hljs-string">"file"</span>, <span class="hljs-string">"error_file"</span>],
                <span class="hljs-string">"level"</span>: log_level,
                <span class="hljs-string">"propagate"</span>: <span class="hljs-literal">False</span>,
            },
        },
    }
    
    <span class="hljs-comment"># Create logs directory if it doesn't exist</span>
    os.makedirs(<span class="hljs-string">"logs"</span>, exist_ok=<span class="hljs-literal">True</span>)
    
    dictConfig(logging_config)
    <span class="hljs-keyword">return</span> logging_config

<span class="hljs-comment"># Initialize logging</span>
logger = logging.getLogger(<span class="hljs-string">"app"</span>)
</div></code></pre>
<h3 id="%F0%9F%93%8A-requestresponse-logging-middleware">ğŸ“Š Request/Response Logging Middleware</h3>
<h4 id="advanced-logging-middleware">Advanced Logging Middleware</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/middleware/logging.py</span>
<span class="hljs-keyword">from</span> starlette.middleware.base <span class="hljs-keyword">import</span> BaseHTTPMiddleware
<span class="hljs-keyword">from</span> starlette.requests <span class="hljs-keyword">import</span> Request
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> uuid

logger = logging.getLogger(<span class="hljs-string">"app.middleware"</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoggingMiddleware</span><span class="hljs-params">(BaseHTTPMiddleware)</span>:</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(self, request: Request, call_next)</span>:</span>
        <span class="hljs-comment"># Generate request ID for tracing</span>
        request_id = str(uuid.uuid4())
        start_time = time.time()
        
        <span class="hljs-comment"># Log request</span>
        <span class="hljs-keyword">await</span> self._log_request(request, request_id)
        
        <span class="hljs-comment"># Process request</span>
        response = <span class="hljs-keyword">await</span> call_next(request)
        
        <span class="hljs-comment"># Calculate processing time</span>
        process_time = time.time() - start_time
        
        <span class="hljs-comment"># Log response</span>
        self._log_response(response, process_time, request_id)
        
        <span class="hljs-comment"># Add request ID to response headers</span>
        response.headers[<span class="hljs-string">"X-Request-ID"</span>] = request_id
        
        <span class="hljs-keyword">return</span> response
    
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_log_request</span><span class="hljs-params">(self, request: Request, request_id: str)</span>:</span>
        <span class="hljs-string">"""ğŸ“¥ Log incoming request"""</span>
        
        <span class="hljs-comment"># Get client IP</span>
        client_ip = request.client.host <span class="hljs-keyword">if</span> request.client <span class="hljs-keyword">else</span> <span class="hljs-string">"unknown"</span>
        
        <span class="hljs-comment"># Get request body for POST/PUT/PATCH</span>
        body = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> request.method <span class="hljs-keyword">in</span> [<span class="hljs-string">"POST"</span>, <span class="hljs-string">"PUT"</span>, <span class="hljs-string">"PATCH"</span>]:
            body = <span class="hljs-keyword">await</span> request.body()
            body_str = body.decode() <span class="hljs-keyword">if</span> body <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
            
            <span class="hljs-comment"># Don't log sensitive data</span>
            <span class="hljs-keyword">if</span> any(sensitive <span class="hljs-keyword">in</span> request.url.path <span class="hljs-keyword">for</span> sensitive <span class="hljs-keyword">in</span> [<span class="hljs-string">"/auth/"</span>, <span class="hljs-string">"/login"</span>, <span class="hljs-string">"/register"</span>]):
                body_str = <span class="hljs-string">"[REDACTED]"</span>
        
        logger.info(
            <span class="hljs-string">"ğŸ“¥ Request"</span>,
            extra={
                <span class="hljs-string">"request_id"</span>: request_id,
                <span class="hljs-string">"method"</span>: request.method,
                <span class="hljs-string">"url"</span>: str(request.url),
                <span class="hljs-string">"path"</span>: request.url.path,
                <span class="hljs-string">"client_ip"</span>: client_ip,
                <span class="hljs-string">"user_agent"</span>: request.headers.get(<span class="hljs-string">"user-agent"</span>, <span class="hljs-string">""</span>),
                <span class="hljs-string">"body"</span>: body_str <span class="hljs-keyword">if</span> body <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,
                <span class="hljs-string">"headers"</span>: dict(request.headers)
            }
        )
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_log_response</span><span class="hljs-params">(self, response, process_time: float, request_id: str)</span>:</span>
        <span class="hljs-string">"""ğŸ“¤ Log outgoing response"""</span>
        
        log_level = logging.INFO
        <span class="hljs-keyword">if</span> response.status_code &gt;= <span class="hljs-number">400</span>:
            log_level = logging.WARNING
        <span class="hljs-keyword">if</span> response.status_code &gt;= <span class="hljs-number">500</span>:
            log_level = logging.ERROR
        
        logger.log(
            log_level,
            <span class="hljs-string">f"ğŸ“¤ Response - <span class="hljs-subst">{response.status_code}</span>"</span>,
            extra={
                <span class="hljs-string">"request_id"</span>: request_id,
                <span class="hljs-string">"status_code"</span>: response.status_code,
                <span class="hljs-string">"process_time"</span>: round(process_time, <span class="hljs-number">4</span>),
                <span class="hljs-string">"response_headers"</span>: dict(response.headers)
            }
        )
</div></code></pre>
<h3 id="%F0%9F%8E%AF-business-logic-logging">ğŸ¯ Business Logic Logging</h3>
<h4 id="service-layer-logging">Service Layer Logging</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/services/user_service.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional, Dict, Any
<span class="hljs-keyword">from</span> app.models.internal.user <span class="hljs-keyword">import</span> UserInDB

logger = logging.getLogger(<span class="hljs-string">"app.services.user"</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span>:</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register_user</span><span class="hljs-params">(self, user_data: Dict[str, Any])</span> -&gt; UserInDB:</span>
        <span class="hljs-string">"""ğŸ‘¤ Register new user with comprehensive logging"""</span>
        
        logger.info(
            <span class="hljs-string">f"ğŸ”„ Starting user registration"</span>,
            extra={
                <span class="hljs-string">"action"</span>: <span class="hljs-string">"register_user"</span>,
                <span class="hljs-string">"username"</span>: user_data.get(<span class="hljs-string">"username"</span>),
                <span class="hljs-string">"email"</span>: user_data.get(<span class="hljs-string">"email"</span>)
            }
        )
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Check if user exists</span>
            existing_user = <span class="hljs-keyword">await</span> self.get_user_by_email(user_data[<span class="hljs-string">"email"</span>])
            <span class="hljs-keyword">if</span> existing_user:
                logger.warning(
                    <span class="hljs-string">f"âŒ Registration failed - email already exists"</span>,
                    extra={
                        <span class="hljs-string">"action"</span>: <span class="hljs-string">"register_user"</span>, 
                        <span class="hljs-string">"email"</span>: user_data[<span class="hljs-string">"email"</span>],
                        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"email_exists"</span>
                    }
                )
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Email already registered"</span>)
            
            <span class="hljs-comment"># Create user</span>
            user = UserInDB(**user_data)
            saved_user = <span class="hljs-keyword">await</span> self.save_user_to_db(user)
            
            logger.info(
                <span class="hljs-string">f"âœ… User registered successfully"</span>,
                extra={
                    <span class="hljs-string">"action"</span>: <span class="hljs-string">"register_user"</span>,
                    <span class="hljs-string">"user_id"</span>: str(saved_user.id),
                    <span class="hljs-string">"username"</span>: saved_user.username,
                    <span class="hljs-string">"email"</span>: saved_user.email
                }
            )
            
            <span class="hljs-keyword">return</span> saved_user
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(
                <span class="hljs-string">f"ğŸ’¥ User registration failed"</span>,
                extra={
                    <span class="hljs-string">"action"</span>: <span class="hljs-string">"register_user"</span>,
                    <span class="hljs-string">"email"</span>: user_data.get(<span class="hljs-string">"email"</span>),
                    <span class="hljs-string">"error"</span>: str(e),
                    <span class="hljs-string">"error_type"</span>: type(e).__name__
                },
                exc_info=<span class="hljs-literal">True</span>
            )
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login_user</span><span class="hljs-params">(self, email: str, password: str)</span> -&gt; Optional[UserInDB]:</span>
        <span class="hljs-string">"""ğŸ” User login with security logging"""</span>
        
        logger.info(
            <span class="hljs-string">f"ğŸ”‘ Login attempt"</span>,
            extra={
                <span class="hljs-string">"action"</span>: <span class="hljs-string">"login_user"</span>,
                <span class="hljs-string">"email"</span>: email
            }
        )
        
        <span class="hljs-keyword">try</span>:
            user = <span class="hljs-keyword">await</span> self.get_user_by_email(email)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
                logger.warning(
                    <span class="hljs-string">f"ğŸš« Login failed - user not found"</span>,
                    extra={
                        <span class="hljs-string">"action"</span>: <span class="hljs-string">"login_user"</span>,
                        <span class="hljs-string">"email"</span>: email,
                        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"user_not_found"</span>
                    }
                )
                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
            
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.verify_password(password, user.hashed_password):
                logger.warning(
                    <span class="hljs-string">f"ğŸš« Login failed - invalid password"</span>,
                    extra={
                        <span class="hljs-string">"action"</span>: <span class="hljs-string">"login_user"</span>,
                        <span class="hljs-string">"email"</span>: email,
                        <span class="hljs-string">"user_id"</span>: str(user.id),
                        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"invalid_password"</span>
                    }
                )
                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
            
            <span class="hljs-comment"># Update last login</span>
            user.last_login = datetime.utcnow()
            <span class="hljs-keyword">await</span> self.update_user_in_db(user)
            
            logger.info(
                <span class="hljs-string">f"âœ… Login successful"</span>,
                extra={
                    <span class="hljs-string">"action"</span>: <span class="hljs-string">"login_user"</span>,
                    <span class="hljs-string">"user_id"</span>: str(user.id),
                    <span class="hljs-string">"email"</span>: email,
                    <span class="hljs-string">"last_login"</span>: user.last_login.isoformat()
                }
            )
            
            <span class="hljs-keyword">return</span> user
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(
                <span class="hljs-string">f"ğŸ’¥ Login error"</span>,
                extra={
                    <span class="hljs-string">"action"</span>: <span class="hljs-string">"login_user"</span>,
                    <span class="hljs-string">"email"</span>: email,
                    <span class="hljs-string">"error"</span>: str(e),
                    <span class="hljs-string">"error_type"</span>: type(e).__name__
                },
                exc_info=<span class="hljs-literal">True</span>
            )
            <span class="hljs-keyword">raise</span>
</div></code></pre>
<h3 id="%F0%9F%94%8D-error-and-exception-logging">ğŸ” Error and Exception Logging</h3>
<h4 id="comprehensive-error-logging">Comprehensive Error Logging</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/core/exception_handlers.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Request, HTTPException
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse
<span class="hljs-keyword">import</span> sys

logger = logging.getLogger(<span class="hljs-string">"app.exceptions"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log_and_handle_exception</span><span class="hljs-params">(request: Request, exc: Exception)</span>:</span>
    <span class="hljs-string">"""ğŸš¨ Comprehensive exception logging and handling"""</span>
    
    <span class="hljs-comment"># Extract request information</span>
    request_info = {
        <span class="hljs-string">"method"</span>: request.method,
        <span class="hljs-string">"url"</span>: str(request.url),
        <span class="hljs-string">"client_ip"</span>: request.client.host <span class="hljs-keyword">if</span> request.client <span class="hljs-keyword">else</span> <span class="hljs-string">"unknown"</span>,
        <span class="hljs-string">"user_agent"</span>: request.headers.get(<span class="hljs-string">"user-agent"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"request_id"</span>: request.headers.get(<span class="hljs-string">"X-Request-ID"</span>, <span class="hljs-string">""</span>)
    }
    
    <span class="hljs-comment"># Get exception details</span>
    exc_type = type(exc).__name__
    exc_message = str(exc)
    exc_traceback = traceback.format_exception(type(exc), exc, exc.__traceback__)
    
    <span class="hljs-keyword">if</span> isinstance(exc, HTTPException):
        <span class="hljs-comment"># HTTP exceptions (4xx, 5xx)</span>
        log_level = logging.WARNING <span class="hljs-keyword">if</span> exc.status_code &lt; <span class="hljs-number">500</span> <span class="hljs-keyword">else</span> logging.ERROR
        
        logger.log(
            log_level,
            <span class="hljs-string">f"ğŸš¨ HTTP Exception: <span class="hljs-subst">{exc.status_code}</span> - <span class="hljs-subst">{exc.detail}</span>"</span>,
            extra={
                <span class="hljs-string">"exception_type"</span>: <span class="hljs-string">"HTTPException"</span>,
                <span class="hljs-string">"status_code"</span>: exc.status_code,
                <span class="hljs-string">"detail"</span>: exc.detail,
                **request_info
            }
        )
        
        <span class="hljs-keyword">return</span> JSONResponse(
            status_code=exc.status_code,
            content={
                <span class="hljs-string">"error"</span>: exc.detail,
                <span class="hljs-string">"status_code"</span>: exc.status_code,
                <span class="hljs-string">"request_id"</span>: request_info[<span class="hljs-string">"request_id"</span>]
            }
        )
    
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># Unhandled exceptions</span>
        logger.error(
            <span class="hljs-string">f"ğŸ’¥ Unhandled Exception: <span class="hljs-subst">{exc_type}</span> - <span class="hljs-subst">{exc_message}</span>"</span>,
            extra={
                <span class="hljs-string">"exception_type"</span>: exc_type,
                <span class="hljs-string">"exception_message"</span>: exc_message,
                <span class="hljs-string">"traceback"</span>: exc_traceback,
                **request_info
            },
            exc_info=<span class="hljs-literal">True</span>
        )
        
        <span class="hljs-comment"># Send to error tracking service (Sentry, etc.)</span>
        <span class="hljs-comment"># sentry_sdk.capture_exception(exc)</span>
        
        <span class="hljs-keyword">return</span> JSONResponse(
            status_code=<span class="hljs-number">500</span>,
            content={
                <span class="hljs-string">"error"</span>: <span class="hljs-string">"Internal server error"</span>,
                <span class="hljs-string">"request_id"</span>: request_info[<span class="hljs-string">"request_id"</span>]
            }
        )
</div></code></pre>
<h3 id="%F0%9F%93%8A-performance-and-monitoring-logs">ğŸ“Š Performance and Monitoring Logs</h3>
<h4 id="performance-monitoring">Performance Monitoring</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/middleware/performance.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> psutil
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> starlette.middleware.base <span class="hljs-keyword">import</span> BaseHTTPMiddleware

logger = logging.getLogger(<span class="hljs-string">"app.performance"</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerformanceMiddleware</span><span class="hljs-params">(BaseHTTPMiddleware)</span>:</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(self, request, call_next)</span>:</span>
        start_time = time.time()
        start_memory = psutil.Process().memory_info().rss / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>  <span class="hljs-comment"># MB</span>
        
        response = <span class="hljs-keyword">await</span> call_next(request)
        
        end_time = time.time()
        end_memory = psutil.Process().memory_info().rss / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>  <span class="hljs-comment"># MB</span>
        
        process_time = end_time - start_time
        memory_diff = end_memory - start_memory
        
        <span class="hljs-comment"># Log slow requests</span>
        <span class="hljs-keyword">if</span> process_time &gt; <span class="hljs-number">1.0</span>:  <span class="hljs-comment"># Requests taking more than 1 second</span>
            logger.warning(
                <span class="hljs-string">f"ğŸŒ Slow request detected"</span>,
                extra={
                    <span class="hljs-string">"url"</span>: str(request.url),
                    <span class="hljs-string">"method"</span>: request.method,
                    <span class="hljs-string">"process_time"</span>: round(process_time, <span class="hljs-number">4</span>),
                    <span class="hljs-string">"memory_usage"</span>: round(memory_diff, <span class="hljs-number">2</span>),
                    <span class="hljs-string">"status_code"</span>: response.status_code
                }
            )
        
        <span class="hljs-comment"># Log performance metrics</span>
        logger.info(
            <span class="hljs-string">f"ğŸ“Š Performance metrics"</span>,
            extra={
                <span class="hljs-string">"url"</span>: str(request.url),
                <span class="hljs-string">"method"</span>: request.method,
                <span class="hljs-string">"process_time"</span>: round(process_time, <span class="hljs-number">4</span>),
                <span class="hljs-string">"memory_usage"</span>: round(memory_diff, <span class="hljs-number">2</span>),
                <span class="hljs-string">"memory_total"</span>: round(end_memory, <span class="hljs-number">2</span>),
                <span class="hljs-string">"status_code"</span>: response.status_code
            }
        )
        
        <span class="hljs-keyword">return</span> response
</div></code></pre>
<h3 id="%F0%9F%93%88-structured-logging-with-context">ğŸ“ˆ Structured Logging with Context</h3>
<h4 id="context-aware-logging">Context-Aware Logging</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/core/context_logging.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> contextvars <span class="hljs-keyword">import</span> ContextVar
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Any, Optional
<span class="hljs-keyword">import</span> uuid

<span class="hljs-comment"># Context variables for request tracing</span>
request_id_var: ContextVar[str] = ContextVar(<span class="hljs-string">'request_id'</span>, default=<span class="hljs-string">''</span>)
user_id_var: ContextVar[str] = ContextVar(<span class="hljs-string">'user_id'</span>, default=<span class="hljs-string">''</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContextFilter</span><span class="hljs-params">(logging.Filter)</span>:</span>
    <span class="hljs-string">"""Add context variables to log records"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">filter</span><span class="hljs-params">(self, record)</span>:</span>
        record.request_id = request_id_var.get(<span class="hljs-string">''</span>)
        record.user_id = user_id_var.get(<span class="hljs-string">''</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContextLogger</span>:</span>
    <span class="hljs-string">"""Logger with automatic context injection"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, name: str)</span>:</span>
        self.logger = logging.getLogger(name)
        self.logger.addFilter(ContextFilter())
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_log_with_context</span><span class="hljs-params">(self, level: int, message: str, extra: Optional[Dict[str, Any]] = None)</span>:</span>
        <span class="hljs-string">"""Log with automatic context injection"""</span>
        <span class="hljs-keyword">if</span> extra <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            extra = {}
        
        <span class="hljs-comment"># Add context to extra data</span>
        extra.update({
            <span class="hljs-string">'request_id'</span>: request_id_var.get(<span class="hljs-string">''</span>),
            <span class="hljs-string">'user_id'</span>: user_id_var.get(<span class="hljs-string">''</span>),
        })
        
        self.logger.log(level, message, extra=extra)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">(self, message: str, **kwargs)</span>:</span>
        self._log_with_context(logging.DEBUG, message, kwargs)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">info</span><span class="hljs-params">(self, message: str, **kwargs)</span>:</span>
        self._log_with_context(logging.INFO, message, kwargs)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">warning</span><span class="hljs-params">(self, message: str, **kwargs)</span>:</span>
        self._log_with_context(logging.WARNING, message, kwargs)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">error</span><span class="hljs-params">(self, message: str, **kwargs)</span>:</span>
        self._log_with_context(logging.ERROR, message, kwargs)

<span class="hljs-comment"># Usage example</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_request_context</span><span class="hljs-params">(request_id: str, user_id: str = <span class="hljs-string">''</span>)</span>:</span>
    <span class="hljs-string">"""Set context for current request"""</span>
    request_id_var.set(request_id)
    user_id_var.set(user_id)

<span class="hljs-comment"># Enhanced logging middleware with context</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContextLoggingMiddleware</span><span class="hljs-params">(BaseHTTPMiddleware)</span>:</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(self, request, call_next)</span>:</span>
        request_id = str(uuid.uuid4())
        user_id = getattr(request.state, <span class="hljs-string">'user_id'</span>, <span class="hljs-string">''</span>)
        
        <span class="hljs-comment"># Set context</span>
        set_request_context(request_id, user_id)
        
        response = <span class="hljs-keyword">await</span> call_next(request)
        response.headers[<span class="hljs-string">"X-Request-ID"</span>] = request_id
        
        <span class="hljs-keyword">return</span> response
</div></code></pre>
<h3 id="%F0%9F%94%A7-log-analysis-and-monitoring">ğŸ”§ Log Analysis and Monitoring</h3>
<h4 id="log-analysis-tools-integration">Log Analysis Tools Integration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># app/core/log_analysis.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Any

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JSONFormatter</span><span class="hljs-params">(logging.Formatter)</span>:</span>
    <span class="hljs-string">"""Format logs as JSON for better parsing"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">format</span><span class="hljs-params">(self, record)</span>:</span>
        log_entry = {
            <span class="hljs-string">"timestamp"</span>: datetime.utcnow().isoformat() + <span class="hljs-string">"Z"</span>,
            <span class="hljs-string">"level"</span>: record.levelname,
            <span class="hljs-string">"logger"</span>: record.name,
            <span class="hljs-string">"message"</span>: record.getMessage(),
            <span class="hljs-string">"module"</span>: record.module,
            <span class="hljs-string">"function"</span>: record.funcName,
            <span class="hljs-string">"line"</span>: record.lineno,
        }
        
        <span class="hljs-comment"># Add extra fields if present</span>
        <span class="hljs-keyword">if</span> hasattr(record, <span class="hljs-string">'request_id'</span>):
            log_entry[<span class="hljs-string">'request_id'</span>] = record.request_id
        <span class="hljs-keyword">if</span> hasattr(record, <span class="hljs-string">'user_id'</span>):
            log_entry[<span class="hljs-string">'user_id'</span>] = record.user_id
        
        <span class="hljs-comment"># Add exception info if present</span>
        <span class="hljs-keyword">if</span> record.exc_info:
            log_entry[<span class="hljs-string">'exception'</span>] = self.formatException(record.exc_info)
        
        <span class="hljs-keyword">return</span> json.dumps(log_entry)

<span class="hljs-comment"># Health check logging</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log_system_health</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""ğŸ¥ Log system health metrics"""</span>
    <span class="hljs-keyword">import</span> psutil
    
    health_logger = logging.getLogger(<span class="hljs-string">"app.health"</span>)
    
    health_metrics = {
        <span class="hljs-string">"cpu_percent"</span>: psutil.cpu_percent(interval=<span class="hljs-number">1</span>),
        <span class="hljs-string">"memory_percent"</span>: psutil.virtual_memory().percent,
        <span class="hljs-string">"disk_percent"</span>: psutil.disk_usage(<span class="hljs-string">'/'</span>).percent,
        <span class="hljs-string">"active_connections"</span>: len(psutil.net_connections()),
    }
    
    health_logger.info(
        <span class="hljs-string">"ğŸ¥ System health metrics"</span>,
        extra=health_metrics
    )

<span class="hljs-comment"># Database query logging</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseQueryLogger</span>:</span>
    <span class="hljs-string">"""ğŸ“Š Log database operations"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.logger = logging.getLogger(<span class="hljs-string">"app.database"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log_query</span><span class="hljs-params">(self, query: str, params: tuple = None, duration: float = <span class="hljs-number">0</span>)</span>:</span>
        <span class="hljs-string">"""Log database query with timing"""</span>
        
        <span class="hljs-comment"># Don't log sensitive data</span>
        safe_params = <span class="hljs-string">"[REDACTED]"</span> <span class="hljs-keyword">if</span> params <span class="hljs-keyword">and</span> any(
            sensitive <span class="hljs-keyword">in</span> query.lower() 
            <span class="hljs-keyword">for</span> sensitive <span class="hljs-keyword">in</span> [<span class="hljs-string">"password"</span>, <span class="hljs-string">"token"</span>, <span class="hljs-string">"secret"</span>]
        ) <span class="hljs-keyword">else</span> params
        
        self.logger.info(
            <span class="hljs-string">f"ğŸ—„ï¸ Database query"</span>,
            extra={
                <span class="hljs-string">"query"</span>: query[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span> <span class="hljs-keyword">if</span> len(query) &gt; <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> query,
                <span class="hljs-string">"params"</span>: safe_params,
                <span class="hljs-string">"duration"</span>: round(duration, <span class="hljs-number">4</span>),
                <span class="hljs-string">"slow_query"</span>: duration &gt; <span class="hljs-number">1.0</span>
            }
        )

<span class="hljs-comment"># Initialize enhanced logging</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup_production_logging</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""ğŸš€ Setup production-ready logging"""</span>
    
    <span class="hljs-comment"># Create logs directory</span>
    <span class="hljs-keyword">import</span> os
    os.makedirs(<span class="hljs-string">"logs"</span>, exist_ok=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># Configure formatters</span>
    json_formatter = JSONFormatter()
    standard_formatter = logging.Formatter(
        <span class="hljs-string">"%(asctime)s | %(levelname)-8s | %(name)s | %(message)s"</span>
    )
    
    <span class="hljs-comment"># Configure handlers</span>
    handlers = {
        <span class="hljs-string">"console"</span>: logging.StreamHandler(),
        <span class="hljs-string">"file"</span>: logging.handlers.RotatingFileHandler(
            <span class="hljs-string">"logs/app.log"</span>, maxBytes=<span class="hljs-number">10485760</span>, backupCount=<span class="hljs-number">5</span>
        ),
        <span class="hljs-string">"json_file"</span>: logging.handlers.RotatingFileHandler(
            <span class="hljs-string">"logs/app.json.log"</span>, maxBytes=<span class="hljs-number">10485760</span>, backupCount=<span class="hljs-number">5</span>
        ),
        <span class="hljs-string">"error_file"</span>: logging.handlers.RotatingFileHandler(
            <span class="hljs-string">"logs/error.log"</span>, maxBytes=<span class="hljs-number">10485760</span>, backupCount=<span class="hljs-number">5</span>
        ),
    }
    
    handlers[<span class="hljs-string">"console"</span>].setFormatter(standard_formatter)
    handlers[<span class="hljs-string">"file"</span>].setFormatter(standard_formatter)
    handlers[<span class="hljs-string">"json_file"</span>].setFormatter(json_formatter)
    handlers[<span class="hljs-string">"error_file"</span>].setFormatter(json_formatter)
    
    <span class="hljs-comment"># Configure root logger</span>
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)
    
    <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">in</span> handlers.values():
        root_logger.addHandler(handler)
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%9A-references--further-reading">ğŸ“š References &amp; Further Reading</h2>
<p>Below are the links and resources referenced in this guide for deeper exploration:</p>
<h3 id="%F0%9F%A7%AA-deployment--production-readiness">ğŸ§ª Deployment &amp; Production Readiness</h3>
<ul>
<li><a href="https://fastapi.tiangolo.com/deployment/">FastAPI Deployment Concepts â€“ Official Docs</a> [^1]</li>
<li><a href="https://github.com/zhanymkanov/fastapi-best-practices">FastAPI Deployment Best Practices (GitHub)</a> [^2]</li>
<li><a href="https://fastapi.tiangolo.com/deployment/concepts/">Deployment Concepts â€“ Official Deep Dive</a> [^3]</li>
<li><a href="https://dev.to/devasservice/fastapi-best-practices-a-condensed-guide-with-examples-3pa5">FastAPI Best Practices â€“ DEV.to</a> [^4]</li>
<li><a href="https://www.koyeb.com/docs/deploy/fastapi">Deploy FastAPI on Koyeb</a> [^5]</li>
<li><a href="https://render.com/docs/deploy-fastapi">Deploy FastAPI on Render</a> [^17]</li>
<li><a href="https://www.blueshoe.io/blog/fastapi-in-production">Production Guide â€“ BlueShoe</a> [^10]</li>
</ul>
<h3 id="%F0%9F%90%9E-debugging">ğŸ Debugging</h3>
<ul>
<li><a href="https://www.linkedin.com/pulse/fastest-way-debug-fastapi-applications-manikandan-parasuraman-rqnie">Debugging FastAPI Apps â€“ LinkedIn Guide</a> [^6]</li>
<li><a href="https://www.youtube.com/watch?v=XlnmN4BfCxw">FastAPI Debugging Tutorial â€“ YouTube</a> [^13]</li>
<li><a href="https://www.getorchestra.io/guides/fastapi-debugging-a-comprehensive-guide-with-examples">FastAPI Debugging Tips â€“ GetOrchestra.io</a> [^18]</li>
<li><a href="https://mathison.ch/en-ch/blog/unraveling-mysteries-your-ultimate-guide-to-debugg/">Unraveling Debugging Mysteries â€“ Mathison Blog</a> [^11]</li>
<li><a href="https://fastapi.tiangolo.com/tutorial/debugging/">FastAPI Debugging â€“ Official Docs</a> [^14]</li>
</ul>
<h3 id="%E2%9C%85-testing">âœ… Testing</h3>
<ul>
<li><a href="https://www.geeksforgeeks.org/python/testing-fastapi-application/">Testing FastAPI â€“ GeeksforGeeks Guide</a> [^7]</li>
<li><a href="https://www.frugaltesting.com/blog/what-is-fastapi-testing-tools-frameworks-and-best-practices">FastAPI Testing Tools &amp; Frameworks â€“ Frugal Testing</a> [^12]</li>
<li><a href="https://apidog.com/blog/unit-testing-fastapi/">Unit Testing FastAPI â€“ Apidog</a> [^15]</li>
<li><a href="https://fastapi.tiangolo.com/tutorial/testing/">FastAPI Testing â€“ Official Docs</a> [^19]</li>
</ul>
<h3 id="%F0%9F%93%8B-logging">ğŸ“‹ Logging</h3>
<ul>
<li><a href="https://www.linkedin.com/pulse/best-practices-logging-fastapi-applications-manikandan-parasuraman-96n2c">Logging Best Practices â€“ LinkedIn</a> [^8]</li>
<li><a href="https://betterstack.com/community/guides/logging/logging-with-fastapi/">BetterStack Logging with FastAPI</a> [^9]</li>
<li><a href="https://konfuzio.com/en/configuration-of-fastapi-logging-locally-and-in-production/">Configure FastAPI Logging (Local &amp; Prod) â€“ Konfuzio</a> [^16]</li>
<li><a href="https://stackoverflow.com/questions/77001129/how-to-configure-fastapi-logging-so-that-it-works-both-with-uvicorn-locally-and">StackOverflow Logging Setup</a> [^20]</li>
</ul>
<hr>
<div align="center">â‚</div>
<h2 id="%F0%9F%93%8C-tips">ğŸ“Œ Tips</h2>
<ul>
<li>Use <strong>separate settings/config files</strong> for <code>development</code> and <code>production</code>.</li>
<li>Always <strong>enable structured logging</strong> for easier monitoring.</li>
<li>Incorporate <strong>Pytest + HTTPX</strong> for writing async test cases.</li>
<li>Use <strong>Gunicorn + Uvicorn workers</strong> for reliable production deployment.</li>
<li>Integrate tools like <strong>Sentry</strong>, <strong>Prometheus</strong>, or <strong>ELK stack</strong> for better observability.</li>
</ul>
<hr>

</body>
</html>
